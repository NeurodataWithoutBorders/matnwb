<script>
(() => {
  let uid = 0;                                // unique id for each block

  function addCopyButtons(root = document){
    root.querySelectorAll('.CodeBlock').forEach(block=>{
      if (block.dataset.copyReady) return;
      block.dataset.copyReady = 'y';

      /* ▸ unique id so tooltip can target the block */
      const targetId = `codecell${uid++}`;
      block.setAttribute('id', targetId);

        const btn = document.createElement('button');
        btn.type  = 'button';
        btn.className = 'copybtn o-tooltip--left';
        btn.dataset.tooltip = 'Copy';          // tooltip text
        btn.setAttribute('aria-label','Copy code');
    
        /*  Two SVGs: copy (default) + check (success)  */
        btn.innerHTML = `
          <!-- copy icon -->
          <svg class="icon-copy icon icon-tabler icon-tabler-copy"
               viewBox="0 0 24 24" aria-hidden="true">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <rect x="8" y="8" width="12" height="12" rx="2"/>
            <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8
                     a2 2 0 0 0 -2 2v8
                     a2 2 0 0 0 2 2h2"/>
          </svg>
    
          <!-- check icon (hidden until .copied) -->
          <svg class="icon-check icon icon-tabler icon-tabler-check"
               viewBox="0 0 24 24" aria-hidden="true">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M5 12l5 5l10 -10" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round" fill="none"/>
          </svg>`;
        block.appendChild(btn);

      /* click → copy */
      btn.addEventListener('click', async () => {
        const lines = [];
        let outputsNode = null;

        block.childNodes.forEach(node=>{
          if (node.nodeType !== 1) return;      // ignore text nodes
          if (node.classList.contains('outputs')){
            outputsNode = node;                 // remember outputs block
            return;                             // stop gathering inputs
          }
          if (node !== btn) lines.push(node.innerText || '');
        });

        /* include FIRST output line */
        if (outputsNode){
          const first = outputsNode.innerText
                       .split(/\r?\n/)          // ← correct regex
                       .find(Boolean) || '';
          lines.push(first);
        }

        const payload = lines.join('').trimEnd();  // no extra blanks

        try {
          await navigator.clipboard.writeText(payload);
          btn.classList.add('copied');
        } finally {
          setTimeout(()=>btn.classList.remove('copied'), 1200);
        }
      });
    });
  }

  /* run at DOM ready */
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ()=>addCopyButtons());
  } else {
    addCopyButtons();
  }

  /* watch for future .CodeBlock nodes */
  new MutationObserver(muts=>{
    muts.forEach(m=>m.addedNodes.forEach(n=>{
      if (n.nodeType === 1) addCopyButtons(n);
    }));
  }).observe(document.body, {childList:true, subtree:true});
})();
</script>
