<script>
(() => {
  function addCopyButtons(root = document){
    root.querySelectorAll('.CodeBlock').forEach(block=>{
      if (block.dataset.copyReady) return;
      block.dataset.copyReady = 'y';

      /* build the button */
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'copy-btn';
      btn.setAttribute('aria-label','Copy code');
      btn.innerHTML = `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1z"/>
          <path d="M19 5H8c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 18H8V7h11v16z"/>
        </svg>`;
      block.appendChild(btn);

      /* click → copy */
      btn.addEventListener('click', async () => {
        const lines = [];
        let outputsNode = null;

        block.childNodes.forEach(node=>{
          if (node.nodeType !== 1) return;      // ignore text nodes
          if (node.classList.contains('outputs')){
            outputsNode = node;                 // remember outputs block
            return;                             // stop gathering inputs
          }
          if (node !== btn) lines.push(node.innerText || '');
        });

        /* include FIRST output line */
        if (outputsNode){
          const first = outputsNode.innerText
                       .split(/\r?\n/)          // ← correct regex
                       .find(Boolean) || '';
          lines.push(first);
        }

        const payload = lines.join('').trimEnd();  // no extra blanks

        try {
          await navigator.clipboard.writeText(payload);
          btn.classList.add('copied');
        } finally {
          setTimeout(()=>btn.classList.remove('copied'), 1200);
        }
      });
    });
  }

  /* run at DOM ready */
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ()=>addCopyButtons());
  } else {
    addCopyButtons();
  }

  /* watch for future .CodeBlock nodes */
  new MutationObserver(muts=>{
    muts.forEach(m=>m.addedNodes.forEach(n=>{
      if (n.nodeType === 1) addCopyButtons(n);
    }));
  }).observe(document.body, {childList:true, subtree:true});
})();
</script>
