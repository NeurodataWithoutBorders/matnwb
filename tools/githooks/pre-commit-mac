#!/bin/bash

# Relative paths
TUTORIAL_FOLDER="tutorials"
PRIVATE_FOLDER="$TUTORIAL_FOLDER/private"

# Get modified files (staged)
MODIFIED_FILES=$(git diff --cached --name-only)

# Check for .mlx files in the tutorials folder
TUTORIAL_FILES=$(echo "$MODIFIED_FILES" | grep "^$TUTORIAL_FOLDER" | grep "\.mlx$")

# If there are tutorial files, check that they have been exported
if [[ -n "$TUTORIAL_FILES" ]]; then
    
    for TUTORIAL_FILE in $TUTORIAL_FILES; do
        # Get the base name without extension
        BASENAME=$(basename "$TUTORIAL_FILE" .mlx)

        # Find corresponding .html and .m files
        HTML_FILE=$(find "$TUTORIAL_FOLDER" -name "$BASENAME.html" -print -quit)
        MC_FILE=$(find "$PRIVATE_FOLDER" -name "$BASENAME.m" -print -quit)

        # Get modification dates (default to 0 if file doesn't exist)
        TUTORIAL_FILE_DATE=$(stat -f "%m" "$TUTORIAL_FILE")
        HTML_FILE_DATE=$(stat -f "%m" "$HTML_FILE" 2>/dev/null || echo 0)
        MC_FILE_DATE=$(stat -f "%m" "$MC_FILE" 2>/dev/null || echo 0)

        # Check if .html or .m file is outdated
        if [[ "$TUTORIAL_FILE_DATE" -gt "$HTML_FILE_DATE" || "$TUTORIAL_FILE_DATE" -gt "$MC_FILE_DATE" ]]; then
            echo "Error: Please re-export html/m-files for live script \"$BASENAME.mlx\"." >&2
            exit 1
        fi
    done
fi

exit 0
