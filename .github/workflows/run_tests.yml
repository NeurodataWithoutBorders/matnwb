# Run and publish MATLAB tests with coverage
name: Run tests

on:
  pull_request:
    branches:
      - master
    paths-ignore:
      - "*.md"
      - "*.codespellrc"
      - ".github/**"
  push:
    branches:
      - master

jobs:
  run_tests:
    name: Run MATLAB tests
    runs-on: ubuntu-latest
    steps:
      - name: check out repository
        uses: actions/checkout@v4
      - name: install python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: configure python env
        run: |
          python -m pip install -U pip
          pip install -r +tests/requirements.txt
          echo "HDF5_PLUGIN_PATH=$(python -c "import hdf5plugin; print(hdf5plugin.PLUGINS_PATH)")" >> "$GITHUB_ENV"
      - name: install MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2024a # this is necessary to test dynamic filters
      - name: run tests
        uses: matlab-actions/run-command@v2
        with:
          command: results = assertSuccess(nwbtest); assert(~isempty(results), 'No tests ran');
      - name: upload JUnit results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: testResults.xml
          retention-days: 1
      - name: upload coverage results
        uses: actions/upload-artifact@v4
        with:
          name: test-coverage
          path: ./coverage.xml
  publish_junit:
    name: Publish JUnit Test Results
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: [run_tests]
    steps:
      - name: retrieve result files
        uses: actions/download-artifact@v4
        with:
          name: test-results
      - name: publish results
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: 'testResults.xml'
  publish_coverage:
    name: Publish Cobertura Test Coverage
    runs-on: ubuntu-latest
    needs: [run_tests]
    steps:
      - name: check out repository
        uses: actions/checkout@v4
      - name: retrieve code coverage files
        uses: actions/download-artifact@v4
        with:
          name: test-coverage
      - name: publish on Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.xml
          name: codecov-matnwb
          verbose: true