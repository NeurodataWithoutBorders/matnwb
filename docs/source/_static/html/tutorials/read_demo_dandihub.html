<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,IE=9,chrome=1"><meta name="generator" content="MATLAB 2023b"><title>Reading NWB Data in MATLAB (DandiHub edition)</title><style type="text/css">.rtcContent { padding: 30px; } .S0 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 28.8px; min-height: 0px; white-space: pre-wrap; color: rgb(192, 76, 11); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 24px; font-weight: 400; text-align: left;  }
.S1 { margin: 2px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 400; text-align: left;  }
.S2 { margin: 20px 10px 5px 4px; padding: 0px; line-height: 20px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 20px; font-weight: 700; text-align: left;  }
.S3 { margin-bottom: 20px; padding-bottom: 4px;  }
.S4 { margin: 0px; padding: 10px 0px 10px 5px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 700; text-align: start;  }
.S5 { margin: -1px 0px 0px; padding: 10px 0px 10px 7px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 400; text-align: start;  }
.CodeBlock{   background:#F5F5F5;   margin:10px 0 10px 0;   padding:0;   display:block;   width:100%;   max-width: 1200px;   min-height:28px;   box-sizing:border-box;   position:relative;       /* anchor for absolute button */   overflow:auto;   font-family:Consolas,Menlo,monospace; } .CodeBlock .copy-btn{   position:absolute;   top:5px;   right:5px;   border:0;   background:none;   cursor:pointer;   line-height:0;   z-index:3; } .CodeBlock .copy-btn svg{   width:18px;   height:18px;   display:block;   overflow:visible;        /* prevents button clipping */   fill:#555;   pointer-events:none; } .CodeBlock .copy-btn:active svg{ fill:#222; } .CodeBlock .copy-btn.copied svg{ fill:#4caf50; }
.S6 { border-left: 1px solid rgb(217, 217, 217); border-right: 1px solid rgb(217, 217, 217); border-top: 1px solid rgb(217, 217, 217); border-bottom: 0px none rgb(33, 33, 33); border-radius: 4px 4px 0px 0px; padding: 6px 45px 0px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S7 { border-left: 1px solid rgb(217, 217, 217); border-right: 1px solid rgb(217, 217, 217); border-top: 0px none rgb(33, 33, 33); border-bottom: 0px none rgb(33, 33, 33); border-radius: 0px; padding: 0px 45px 0px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S8 { border-left: 1px solid rgb(217, 217, 217); border-right: 1px solid rgb(217, 217, 217); border-top: 0px none rgb(33, 33, 33); border-bottom: 1px solid rgb(217, 217, 217); border-radius: 0px; padding: 0px 45px 4px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S9 { color: rgb(33, 33, 33); padding: 10px 0px 6px 17px; background: rgb(255, 255, 255) none repeat scroll 0% 0% / auto padding-box border-box; font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px; overflow-x: hidden; line-height: 17.234px;  }
/* Styling that is common to warnings and errors is in diagnosticOutput.css */.embeddedOutputsErrorElement {    min-height: 18px;    max-height: 550px;}
.embeddedOutputsErrorElement .diagnosticMessage-errorType {    overflow: auto;}
.embeddedOutputsErrorElement.inlineElement {}
.embeddedOutputsErrorElement.rightPaneElement {}
/* Styling that is common to warnings and errors is in diagnosticOutput.css */.embeddedOutputsWarningElement {    min-height: 18px;    max-height: 550px;}
.embeddedOutputsWarningElement .diagnosticMessage-warningType {    overflow: auto;}
.embeddedOutputsWarningElement.inlineElement {}
.embeddedOutputsWarningElement.rightPaneElement {}
/* Copyright 2015-2023 The MathWorks, Inc. *//* In this file, styles are not scoped to rtcContainer since they could be in the Dojo Tooltip */.diagnosticMessage-wrapper {    font-family: Menlo, Monaco, Consolas, "Courier New", monospace;    font-size: 12px;}
.diagnosticMessage-wrapper.diagnosticMessage-warningType {    /*This fallback value will be used for appdesigner warnings*/    color: var(--rtc-warning-output-color, var(--mw-color-matlabWarning));}
.diagnosticMessage-wrapper.diagnosticMessage-warningType a {    /*This fallback value will be used for appdesigner warnings*/    color: var(--rtc-warning-output-color, var(--mw-color-matlabWarning));    text-decoration: underline;}
.rtcThemeDefaultOverride .diagnosticMessage-wrapper.diagnosticMessage-warningType,.rtcThemeDefaultOverride .diagnosticMessage-wrapper.diagnosticMessage-warningType a {    color: var(--mw-color-matlabWarning) !important;}
.diagnosticMessage-wrapper.diagnosticMessage-errorType {    /*This fallback value will be used in appdesigner error tooltip text*/    color: var(--rtc-error-output-color, var(--mw-color-matlabErrors));}
.diagnosticMessage-wrapper.diagnosticMessage-errorType a {    /*This fallback value will be used in appdesigner error tooltip text*/    color: var(--rtc-error-output-color, var(--mw-color-matlabErrors));    text-decoration: underline;}
.rtcThemeDefaultOverride .diagnosticMessage-wrapper.diagnosticMessage-errorType,.rtcThemeDefaultOverride .diagnosticMessage-wrapper.diagnosticMessage-errorType a {    color: var(--mw-color-matlabErrors) !important;}
.diagnosticMessage-wrapper .diagnosticMessage-messagePart,.diagnosticMessage-wrapper .diagnosticMessage-causePart {    white-space: pre-wrap;}
.diagnosticMessage-wrapper .diagnosticMessage-stackPart {    white-space: pre;}
.embeddedOutputsTextElement,.embeddedOutputsVariableStringElement {    white-space: pre;    word-wrap:  initial;    min-height: 18px;    max-height: 550px;}
.embeddedOutputsTextElement .textElement,.embeddedOutputsVariableStringElement .textElement {    overflow: auto;}
.textElement,.rtcDataTipElement .textElement {    padding-top: 2px;}
.embeddedOutputsTextElement.inlineElement,.embeddedOutputsVariableStringElement.inlineElement {}
.inlineElement .textElement {}
.embeddedOutputsTextElement.rightPaneElement,.embeddedOutputsVariableStringElement.rightPaneElement {    min-height: 16px;}
.rightPaneElement .textElement {    padding-top: 2px;    padding-left: 9px;}
.S10 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 20px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 20px; font-weight: 700; text-align: left;  }
.S11 { border-left: 1px solid rgb(217, 217, 217); border-right: 1px solid rgb(217, 217, 217); border-top: 1px solid rgb(217, 217, 217); border-bottom: 1px solid rgb(217, 217, 217); border-radius: 4px 4px 0px 0px; padding: 6px 45px 4px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S12 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 18px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 17px; font-weight: 700; text-align: left;  }
.S13 { border-left: 1px solid rgb(217, 217, 217); border-right: 1px solid rgb(217, 217, 217); border-top: 1px solid rgb(217, 217, 217); border-bottom: 1px solid rgb(217, 217, 217); border-radius: 4px; padding: 6px 45px 4px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S14 { margin: 10px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 400; text-align: left;  }
.S15 { border-left: 1px solid rgb(217, 217, 217); border-right: 1px solid rgb(217, 217, 217); border-top: 0px none rgb(33, 33, 33); border-bottom: 1px solid rgb(217, 217, 217); border-radius: 0px 0px 4px 4px; padding: 0px 45px 4px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }</style></head><body><div class = rtcContent><h1  class = 'S0' id = 'T_B8DB5017' ><span>Reading NWB Data in MATLAB (DandiHub edition)</span></h1><div  class = 'S1' id = 'H_5D05D5B9' ><span>Authors: Ryan Ly, with modification by Lawrence Niu</span></div><div  class = 'S1'><span>DandiHub edition* authors: Thomas Kuenzel &amp; Vijay Iyer</span></div><div  class = 'S1'><span>Last Updated: 2023-09-05</span></div><div  class = 'S1'><span>(*) minimally modified to utilize </span><span style=' font-family: monospace;'>dandi</span><span> package for download and to skip the MatNWB installation </span></div><h2  class = 'S2' id = 'H_AEF597F8' ><span>Introduction</span></h2><div  class = 'S1'><span>In this tutorial, we will read single neuron spiking data that is in the NWB standard format and do a basic visualization of the data. More thorough documentation regarding reading files as well as the </span><span style=' font-family: monospace;'>NwbFile</span><span> class, can be found in the </span><a href = "https://nwb-overview.readthedocs.io/en/latest/file_read/file_read.html#reading-with-matnwb"><span>NWB Overview Documentation</span></a></div><div  class = 'S3'><div  class = 'S4'><span style=' font-weight: bold;'>Table of Contents</span></div><div  class = 'S5'><a href = "#H_AEF597F8"><span>Introduction
</span></a><a href = "#H_4596"><span>Download the Dataset
</span></a><a href = "#H_CB19E5AC"><span>Read the NWB file
</span></a><span>    </span><a href = "#H_69924E02"><span>Stimulus
</span></a><a href = "#H_01DD834C"><span>Quick PSTH and raster
</span></a><a href = "#H_716AA928"><span>Plot results
</span></a><a href = "#H_E2BE29FD"><span>Conclusion</span></a></div></div><h2  class = 'S2' id = 'H_4596' ><span>Download the Dataset</span></h2><div  class = 'S1'><span>Use the </span><span style=' font-family: monospace;'>dandi</span><span> Python package to download the dataset to the user-local dandisets folder. If you are running this livescript on DandiHub, the </span><span style=' font-family: monospace;'>dandi</span><span> package is already pre-installed. On a local environment, you need to install the </span><span style=' font-family: monospace;'>dandi</span><span> package in the python environment returned by running </span><span style=' font-family: monospace;'>pyenv()</span><span> in MATLAB.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >environment = </span></span><span style="color: rgb(167, 9, 245);">"Local"</span><span style="white-space: pre"><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">switch </span><span >environment</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    </span><span style="color: #0e00ff;">case </span><span style="color: #a709f5;">"DandiHub"</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >        targetFolder = </span><span style="color: #a709f5;">"/home/jovyan/dandisets/000004"</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    </span><span style="color: #0e00ff;">case </span><span style="color: #a709f5;">"Local"</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >        targetFolder = fullfile(userpath(), </span><span style="color: #a709f5;">"dandisets"</span><span >, </span><span style="color: #a709f5;">"000004"</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">end</span></span></div></div><div class="inlineWrapper outputs"><div  class = 'S8'><span style="white-space: pre"><span >py.dandi.download.download(</span><span style="color: #a709f5;">"dandi://dandi/000004/sub-P11HMH/"</span><span >, targetFolder, existing=</span><span style="color: #a709f5;">'overwrite'</span><span >)</span></span></div><div  class = 'S9'><div class="inlineElement eoOutputWrapper disableDefaultGestureHandling embeddedOutputsTextElement" uid="2C01B92A" prevent-scroll="true" data-testid="output_0" tabindex="-1" style="width: 1145px; white-space: pre; font-style: normal; color: rgb(33, 33, 33); font-size: 12px;"><div class="textElement eoOutputContent" tabindex="-1" data-previous-available-width="1108" data-previous-scroll-height="61" data-hashorizontaloverflow="false" style="max-height: 261px; white-space: pre; font-style: normal; color: rgb(33, 33, 33); font-size: 12px;">PATH                                                 SIZE    DONE            DONE% CHECKSUM STATUS          MESSAGE
sub-P11HMH/sub-P11HMH_ses-20061101_ecephys+image.nwb 72.6 MB 72.6 MB          100%    ok    done                   
Summary:                                             72.6 MB 72.6 MB                        1 done                 
                                                             100.00%                                               </div></div></div></div></div><h2  class = 'S10' id = 'H_CB19E5AC' ><span>Read the NWB file</span></h2><div  class = 'S1'><span>You can read any NWB file using </span><span style=' font-family: monospace;'>nwbRead</span><span>. You will find that the print out for this shows a summary of the data within.</span></div><div class="CodeBlock"><div class="inlineWrapper outputs"><div  class = 'S11'><span style="white-space: pre"><span >nwb = nwbRead(fullfile(targetFolder, </span><span style="color: #a709f5;">"sub-P11HMH"</span><span >, </span><span style="color: #a709f5;">"sub-P11HMH_ses-20061101_ecephys+image.nwb"</span><span >))</span></span></div><div  class = 'S9'><div class="inlineElement eoOutputWrapper disableDefaultGestureHandling embeddedOutputsErrorElement" uid="8DA1D480" prevent-scroll="true" data-testid="output_1" tabindex="-1" style="width: 1145px; white-space: normal; font-style: normal; color: rgb(33, 33, 33); font-size: 12px;"><div class="diagnosticMessage-wrapper diagnosticMessage-errorType eoOutputContent" tabindex="-1" data-previous-available-width="1108" data-previous-scroll-height="78" data-hashorizontaloverflow="false" style="max-height: 261px; white-space: normal; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;"><div class="diagnosticMessage-messagePart" style="white-space: pre-wrap; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;">Error using nwbRead<br style="white-space: pre-wrap; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;">The class 'types.core.DynamicTable' is not a superclass of class 'types.core.TimeIntervals', as required to invoke a superclass constructor or method.</div><div class="diagnosticMessage-stackPart" style="white-space: pre; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;"></div><div class="diagnosticMessage-causePart" style="white-space: pre-wrap; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;"><br style="white-space: pre-wrap; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;">Caused by:<br style="white-space: pre-wrap; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;">    This error typically occurs if NWB objects created with a different version are still loaded in memory. Try using `clear all` and run `nwbRead` again.</div></div></div></div></div></div><h3  class = 'S12' id = 'H_69924E02' ><span>Stimulus</span></h3><div  class = 'S1'><span>Now lets take a look at the visual stimuli presented to the subject. They will be in </span><span style=' font-family: monospace;'>nwb.stimulus_presentation</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S13'><span style="white-space: pre"><span >nwb.stimulus_presentation</span></span></div></div></div><div  class = 'S14'><span>This results shows us that </span><span style=' font-family: monospace;'>nwb.stimulus_presentation</span><span> is a </span><span style=' font-family: monospace;'>Set</span><span> object that contains a single data object called </span><span style=' font-family: monospace;'>StimulusPresentation</span><span>, which is an </span><span style=' font-family: monospace;'>OpticalSeries</span><span> neurodata type. Use the </span><span style=' font-family: monospace;'>get</span><span> method to return this </span><span style=' font-family: monospace;'>OpticalSeries</span><span>. </span><span style=' font-family: monospace;'>Set</span><span> objects store a collection of other NWB objects.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S13'><span style="white-space: pre"><span >nwb.stimulus_presentation.get(</span><span style="color: #a709f5;">'StimulusPresentation'</span><span >)</span></span></div></div></div><div  class = 'S14'><span style=' font-family: monospace;'>OpticalSeries</span><span> is a neurodata type that stores information about visual stimuli presented to subjects. This print out shows all of the attributes in the </span><span style=' font-family: monospace;'>OpticalSeries</span><span> object named </span><span style=' font-family: monospace;'>StimulusPresentation</span><span>. The images are stored in </span><span style=' font-family: monospace;'>StimulusPresentation.data</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S13'><span style="white-space: pre"><span >StimulusImageData = nwb.stimulus_presentation.get(</span><span style="color: #a709f5;">'StimulusPresentation'</span><span >).data</span></span></div></div></div><div  class = 'S14'><span>When calling a data object directly, the data is not read but instead a </span><span style=' font-family: monospace;'>DataStub</span><span> is returned. This is because data is read "lazily" in MatNWB. Instead of reading the entire dataset into memory, this provides a "window" into the data stored on disk that allows you to read only a section of the data. In this case, the last dimension indexes over images. You can index into any </span><span style=' font-family: monospace;'>DataStub</span><span> as you would any MATLAB matrix.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: #008013;">% get the image and display it</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #008013;">% the dimension order is provided as follows:</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #008013;">% [rgb, y, x, image index]</span></span></div></div><div class="inlineWrapper"><div  class = 'S15'><span style="white-space: pre"><span >img = StimulusImageData(1:3, 1:300, 1:400, 32);</span></span></div></div></div><div  class = 'S14'><span>A bit of manipulation allows us to display the image using MATLAB's </span><span style=' font-family: monospace;'>imshow</span><span>.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >img = permute(img,[3, 2, 1]);  </span><span style="color: #008013;">% fix orientation</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >img = flip(img, 3); </span><span style="color: #008013;">% reverse color order</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >F = figure();</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >imshow(img, </span><span style="color: #a709f5;">'InitialMagnification'</span><span >, </span><span style="color: #a709f5;">'fit'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S15'><span style="white-space: pre"><span >daspect([3, 5, 5]);</span></span></div></div></div><div  class = 'S1'><span>To read an entire dataset, use the </span><span style=' font-family: monospace;'>DataStub.load</span><span> method without any input arguments. We will use this approach to read all of the image display timestamps into memory.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S13'><span style="white-space: pre"><span >stimulus_times = nwb.stimulus_presentation.get(</span><span style="color: #a709f5;">'StimulusPresentation'</span><span >).timestamps.load();</span></span></div></div></div><h2  class = 'S10' id = 'H_01DD834C' ><span>Quick PSTH and raster</span></h2><div  class = 'S1'><span>Here, I will pull out spike times of a particular unit, align them to the image display times, and finally display the results.</span></div><div  class = 'S1'><span>First, let us show the first row of the NWB Units table representing the first unit.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S13'><span style="white-space: pre"><span >nwb.units.getRow(1)</span></span></div></div></div><div  class = 'S1'><span>Let us specify some parameters for creating a cell array of spike times aligned to each stimulus time. </span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: #008013;">%% Align spikes by stimulus presentations</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >unit_ind =</span></span><span>8</span><span style="white-space: pre"><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >before =</span></span><span>1</span><span style="white-space: pre"><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S15'><span style="white-space: pre"><span >after =</span></span><span>3</span><span style="white-space: pre"><span >;</span></span></div></div></div><div  class = 'S14'><span style=' font-family: monospace;'>getRow</span><span> provides a convenient method for reading this data out.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S13'><span style="white-space: pre"><span >unit_spikes = nwb.units.getRow(unit_ind, </span><span style="color: #a709f5;">'columns'</span><span >, {</span><span style="color: #a709f5;">'spike_times'</span><span >}).spike_times{1}</span></span></div></div></div><div  class = 'S14'><span>Spike times from this unit are aligned to each stimulus time and compiled in a cell array</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >results = cell(1, length(stimulus_times));</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">for </span><span >itime = 1:length(stimulus_times)</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    stimulus_time = stimulus_times(itime);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    spikes = unit_spikes - stimulus_time;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    spikes = spikes(spikes &gt; -before);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    spikes = spikes(spikes &lt; after);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    results{itime} = spikes;</span></span></div></div><div class="inlineWrapper"><div  class = 'S15'><span style="white-space: pre"><span style="color: #0e00ff;">end</span></span></div></div></div><h2  class = 'S10' id = 'H_716AA928' ><span>Plot results</span></h2><div  class = 'S1'><span>Finally, here is a (slightly sloppy) peri-stimulus time histogram</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >figure();</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >hold </span><span style="color: #a709f5;">on</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">for </span><span >i = 1:length(results)</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    spikes = results{i};</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    yy = ones(length(spikes)) * i;</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >    plot(spikes, yy, </span><span style="color: #a709f5;">'k.'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: #0e00ff;">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >hold </span><span style="color: #a709f5;">off</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >ylabel(</span><span style="color: #a709f5;">'trial'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >xlabel(</span><span style="color: #a709f5;">'time (s)'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S15'><span style="white-space: pre"><span >axis(</span><span style="color: #a709f5;">'tight'</span><span >)</span></span></div></div></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >figure();</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >all_spikes = cat(1, results{:});</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >histogram(all_spikes, 30);</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >ylabel(</span><span style="color: #a709f5;">'count'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span >xlabel(</span><span style="color: #a709f5;">'time (s)'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S15'><span style="white-space: pre"><span >axis(</span><span style="color: #a709f5;">'tight'</span><span >)</span></span></div></div></div><h2  class = 'S10' id = 'H_E2BE29FD' ><span>Conclusion</span></h2><div  class = 'S1'><span>This is an example of how to get started with understanding and analyzing public NWB datasets. This particular dataset was published with an extensive open analysis conducted in both MATLAB and Python, which you can find </span><a href = "https://github.com/rutishauserlab/recogmem-release-NWB"><span>here</span></a><span>. For more datasets, or to publish your own NWB data for free, check out the DANDI archive </span><a href = "http://dandiarchive.org/"><span>here</span></a><span>. </span></div><div  class = 'S1'></div>
<br>
<!-- 
##### SOURCE BEGIN #####
%% Reading NWB Data in MATLAB (DandiHub edition)
% Authors: Ryan Ly, with modification by Lawrence Niu
% 
% DandiHub edition* authors: Thomas Kuenzel & Vijay Iyer
% 
% Last Updated: 2023-09-05
% 
% (*) minimally modified to utilize |dandi| package for download and to skip 
% the MatNWB installation 
%% Introduction
% In this tutorial, we will read single neuron spiking data that is in the NWB 
% standard format and do a basic visualization of the data. More thorough documentation 
% regarding reading files as well as the |NwbFile| class, can be found in the 
% <https://nwb-overview.readthedocs.io/en/latest/file_read/file_read.html#reading-with-matnwb 
% NWB Overview Documentation>
%% Download the Dataset
% Use the |dandi| Python package to download the dataset to the user-local dandisets 
% folder. If you are running this livescript on DandiHub, the |dandi| package 
% is already pre-installed. On a local environment, you need to install the |dandi| 
% package in the python environment returned by running |pyenv()| in MATLAB.

environment = "Local";
switch environment
    case "DandiHub"
        targetFolder = "/home/jovyan/dandisets/000004";
    case "Local"
        targetFolder = fullfile(userpath(), "dandisets", "000004");
end
py.dandi.download.download("dandi://dandi/000004/sub-P11HMH/", targetFolder, existing='overwrite')
%% Read the NWB file
% You can read any NWB file using |nwbRead|. You will find that the print out 
% for this shows a summary of the data within.

nwb = nwbRead(fullfile(targetFolder, "sub-P11HMH", "sub-P11HMH_ses-20061101_ecephys+image.nwb"))
% Stimulus
% Now lets take a look at the visual stimuli presented to the subject. They 
% will be in |nwb.stimulus_presentation|

nwb.stimulus_presentation
%% 
% This results shows us that |nwb.stimulus_presentation| is a |Set| object that 
% contains a single data object called |StimulusPresentation|, which is an |OpticalSeries| 
% neurodata type. Use the |get| method to return this |OpticalSeries|. |Set| objects 
% store a collection of other NWB objects.

nwb.stimulus_presentation.get('StimulusPresentation')
%% 
% |OpticalSeries| is a neurodata type that stores information about visual stimuli 
% presented to subjects. This print out shows all of the attributes in the |OpticalSeries| 
% object named |StimulusPresentation|. The images are stored in |StimulusPresentation.data|

StimulusImageData = nwb.stimulus_presentation.get('StimulusPresentation').data
%% 
% When calling a data object directly, the data is not read but instead a |DataStub| 
% is returned. This is because data is read "lazily" in MatNWB. Instead of reading 
% the entire dataset into memory, this provides a "window" into the data stored 
% on disk that allows you to read only a section of the data. In this case, the 
% last dimension indexes over images. You can index into any |DataStub| as you 
% would any MATLAB matrix.

% get the image and display it
% the dimension order is provided as follows:
% [rgb, y, x, image index]
img = StimulusImageData(1:3, 1:300, 1:400, 32);
%% 
% A bit of manipulation allows us to display the image using MATLAB's |imshow|.

img = permute(img,[3, 2, 1]);  % fix orientation
img = flip(img, 3); % reverse color order
F = figure();
imshow(img, 'InitialMagnification', 'fit');
daspect([3, 5, 5]);
%% 
% To read an entire dataset, use the |DataStub.load| method without any input 
% arguments. We will use this approach to read all of the image display timestamps 
% into memory.

stimulus_times = nwb.stimulus_presentation.get('StimulusPresentation').timestamps.load();
%% Quick PSTH and raster
% Here, I will pull out spike times of a particular unit, align them to the 
% image display times, and finally display the results.
% 
% First, let us show the first row of the NWB Units table representing the first 
% unit.

nwb.units.getRow(1)
%% 
% Let us specify some parameters for creating a cell array of spike times aligned 
% to each stimulus time. 

%% Align spikes by stimulus presentations

unit_ind =8;
before =1;
after =3;
%% 
% |getRow| provides a convenient method for reading this data out.

unit_spikes = nwb.units.getRow(unit_ind, 'columns', {'spike_times'}).spike_times{1}
%% 
% Spike times from this unit are aligned to each stimulus time and compiled 
% in a cell array

results = cell(1, length(stimulus_times));
for itime = 1:length(stimulus_times)
    stimulus_time = stimulus_times(itime);
    spikes = unit_spikes - stimulus_time;
    spikes = spikes(spikes > -before);
    spikes = spikes(spikes < after);
    results{itime} = spikes;
end
%% Plot results
% Finally, here is a (slightly sloppy) peri-stimulus time histogram

figure();
hold on
for i = 1:length(results)
    spikes = results{i};
    yy = ones(length(spikes)) * i;

    plot(spikes, yy, 'k.');
end
hold off
ylabel('trial');
xlabel('time (s)');
axis('tight')
%%
figure();
all_spikes = cat(1, results{:});
histogram(all_spikes, 30);
ylabel('count')
xlabel('time (s)');
axis('tight')
%% Conclusion
% This is an example of how to get started with understanding and analyzing 
% public NWB datasets. This particular dataset was published with an extensive 
% open analysis conducted in both MATLAB and Python, which you can find <https://github.com/rutishauserlab/recogmem-release-NWB 
% here>. For more datasets, or to publish your own NWB data for free, check out 
% the DANDI archive <http://dandiarchive.org/ here>. 
% 
%
##### SOURCE END #####
-->
</div><script>
/*  This runs only inside the embedded file.
    It turns a click on   foo.html   into a jump to
    /pages/.../foo.html   *outside* the iframe,
    and still breaks out for any https:// link.            */
document.addEventListener("DOMContentLoaded", () => {
  if (window.self === window.top) return;        // not inside an iframe? do nothing

  const STATIC_PREFIX = "/_static/html/";        // where the raw HTML lives
  const PAGES_PREFIX  = "/pages/";               // where the real doc pages live

  document.querySelectorAll("a[href]").forEach(a => {
    const href = a.getAttribute("href");

    /* 1 — always leave the iframe for https:// or *.html links */
    if (href.startsWith("https:") || href.endsWith(".html")) {
      a.setAttribute("target", "_top");
    }

    /* 2 — for a *relative* foo.html       rewrite it so it
           points at …/pages/… not …/_static/html/…           */
    const isRelativeHtml = href.endsWith(".html") && !/^[a-z]+:\/\//i.test(href);
    if (isRelativeHtml) {
      const here = window.location.pathname;          // /en/_static/html/tutorials/intro.html
      const base = here
        .replace(STATIC_PREFIX, PAGES_PREFIX)         // /en/pages/tutorials/intro.html
        .replace(/[^/]+$/, "");                       // /en/pages/tutorials/
      a.href = base + href.replace(/^\.\//, "");      // final: /en/pages/tutorials/foo.html
    }
  });
});
</script>
<script>
(() => {
  function addCopyButtons(root = document){
    root.querySelectorAll('.CodeBlock').forEach(block=>{
      if (block.dataset.copyReady) return;
      block.dataset.copyReady = 'y';

      /* build the button */
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'copy-btn';
      btn.setAttribute('aria-label','Copy code');
      btn.innerHTML = `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1z"/>
          <path d="M19 5H8c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 18H8V7h11v16z"/>
        </svg>`;
      block.appendChild(btn);

      /* click → copy */
      btn.addEventListener('click', async () => {
        const lines = [];
        let outputsNode = null;

        block.childNodes.forEach(node=>{
          if (node.nodeType !== 1) return;      // ignore text nodes
          if (node.classList.contains('outputs')){
            outputsNode = node;                 // remember outputs block
            return;                             // stop gathering inputs
          }
          if (node !== btn) lines.push(node.innerText || '');
        });

        /* include FIRST output line */
        if (outputsNode){
          const first = outputsNode.innerText
                       .split(/\r?\n/)          // ← correct regex
                       .find(Boolean) || '';
          lines.push(first);
        }

        const payload = lines.join('').trimEnd();  // no extra blanks

        try {
          await navigator.clipboard.writeText(payload);
          btn.classList.add('copied');
        } finally {
          setTimeout(()=>btn.classList.remove('copied'), 1200);
        }
      });
    });
  }

  /* run at DOM ready */
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ()=>addCopyButtons());
  } else {
    addCopyButtons();
  }

  /* watch for future .CodeBlock nodes */
  new MutationObserver(muts=>{
    muts.forEach(m=>m.addedNodes.forEach(n=>{
      if (n.nodeType === 1) addCopyButtons(n);
    }));
  }).observe(document.body, {childList:true, subtree:true});
})();
</script>
</body></html>